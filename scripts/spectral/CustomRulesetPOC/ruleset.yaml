extends:
  - spectral:oas

rules:
  oas3-schema:
    severity: off

  require-security-controls-contract:
    description: API specs must declare security control settings in x-security-controls.
    message: Define x-security-controls with rateLimiting, inputValidation, and errorHandling sections.
    severity: error
    given: $
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          required:
            - x-security-controls
          properties:
            x-security-controls:
              type: object
              required:
                - rateLimiting
                - inputValidation
                - errorHandling

  ip-based-throttling-enabled:
    description: IP-based throttling must be configured.
    message: Set x-security-controls.rateLimiting.ipBasedThrottling to true.
    severity: error
    given: $.x-security-controls.rateLimiting
    then:
      field: ipBasedThrottling
      function: truthy

  subscription-user-rate-limits-enabled:
    description: Subscription or user rate limiting must be configured.
    message: Set x-security-controls.rateLimiting.subscriptionOrUserRateLimits to true.
    severity: error
    given: $.x-security-controls.rateLimiting
    then:
      field: subscriptionOrUserRateLimits
      function: truthy

  spike-arrest-enabled:
    description: Spike arrest must be enabled.
    message: Set x-security-controls.rateLimiting.spikeArrest to true.
    severity: error
    given: $.x-security-controls.rateLimiting
    then:
      field: spikeArrest
      function: truthy

  payload-size-limit-defined:
    description: Payload size limit must be explicitly configured.
    message: Set x-security-controls.rateLimiting.payloadSizeLimitKb to a value >= 1.
    severity: error
    given: $.x-security-controls.rateLimiting
    then:
      field: payloadSizeLimitKb
      function: schema
      functionOptions:
        schema:
          type: integer
          minimum: 1

  account-recovery-thresholds-defined:
    description: Login/account recovery thresholds must be stricter and explicit.
    message: Define maxAttempts and windowSeconds under x-security-controls.rateLimiting.accountRecoveryThresholds.
    severity: error
    given: $.x-security-controls.rateLimiting
    then:
      field: accountRecoveryThresholds
      function: schema
      functionOptions:
        schema:
          type: object
          required:
            - maxAttempts
            - windowSeconds
          properties:
            maxAttempts:
              type: integer
              minimum: 1
              maximum: 10
            windowSeconds:
              type: integer
              minimum: 60

  content-type-enforcement-enabled:
    description: Content-Type enforcement must be enabled.
    message: Set x-security-controls.inputValidation.contentTypeEnforcement to true.
    severity: error
    given: $.x-security-controls.inputValidation
    then:
      field: contentTypeEnforcement
      function: truthy

  schema-validation-at-gateway-enabled:
    description: Schema validation at gateway must be enabled.
    message: Set x-security-controls.inputValidation.schemaValidationAtGateway to true.
    severity: error
    given: $.x-security-controls.inputValidation
    then:
      field: schemaValidationAtGateway
      function: truthy

  waf-protection-enabled:
    description: WAF protection for SQLi/XSS must be enabled.
    message: Set x-security-controls.inputValidation.wafProtection to true.
    severity: error
    given: $.x-security-controls.inputValidation
    then:
      field: wafProtection
      function: truthy

  header-validation-enabled:
    description: Header validation must be enabled.
    message: Set x-security-controls.inputValidation.headerValidation to true.
    severity: error
    given: $.x-security-controls.inputValidation
    then:
      field: headerValidation
      function: truthy

  no-wildcard-request-content-type:
    description: Wildcard request content-types are not allowed.
    message: Do not use */* as a requestBody content type.
    severity: warn
    given: $.paths[*][*].requestBody.content
    then:
      function: schema
      functionOptions:
        schema:
          type: object
          propertyNames:
            not:
              const: '*/*'

  generic-external-errors-enabled:
    description: External error messages must be generic.
    message: Set x-security-controls.errorHandling.genericExternalErrors to true.
    severity: error
    given: $.x-security-controls.errorHandling
    then:
      field: genericExternalErrors
      function: truthy

  structured-log-analytics-enabled:
    description: Structured logging to Log Analytics must be enabled.
    message: Set x-security-controls.errorHandling.structuredLoggingToLogAnalytics to true.
    severity: error
    given: $.x-security-controls.errorHandling
    then:
      field: structuredLoggingToLogAnalytics
      function: truthy

  secure-log-storage-enabled:
    description: Secure log storage must be enabled.
    message: Set x-security-controls.errorHandling.secureLogStorage to true.
    severity: error
    given: $.x-security-controls.errorHandling
    then:
      field: secureLogStorage
      function: truthy
